<html>
    <head>
        <meta name='viewport' content="width=device-width, initial-scale=1.0">
        <title>Admin - Absensi SMAN 1 CIBADAK</title>
        <link href="/assets/css/bootstrap.css" rel="stylesheet" type="text/css"/>
        <script src="/assets/js/chart.js"></script>
        <link href="/assets/css/chart.css" rel="stylesheet" type="text/css"/>
        <script src="/assets/js/jquery-3.4.1.js"></script>
        <link href="/assets/css/all.css" rel="stylesheet" type="text/css"/>
        <script src="/assets/js/bootstrap.bundle.js"></script>
        <script src="/assets/js/bootstrap.js"></script>
        <script src="/assets/js/jquery-ui.js" type="text/javascript"></script>
        <link href="/assets/css/jquery-ui.css" rel="stylesheet" type="text/css"/>
        <script src="/assets/js/jquery.ui.timepicker.js" type="text/javascript"></script>
        <link href="/assets/css/jquery.ui.timepicker.css" rel="stylesheet" type="text/css"/>
    </head>
    <style>
        #body-row {
            margin-left:0;
            margin-right:0;
        }
        #sidebar-container {
            min-height: 100vh;   
            background-color: #333;
            padding: 0;
        }

        /* Sidebar sizes when expanded and expanded */
        .sidebar-expanded {
            width: 230px;
        }
        .sidebar-collapsed {
            width: 60px;
        }

        /* Menu item*/
        #sidebar-container .list-group a {
            height: 50px;
            color: white;
        }

        /* Submenu item*/
        #sidebar-container .list-group .sidebar-submenu a {
            height: 45px;
            padding-left: 30px;
        }
        .sidebar-submenu {
            font-size: 0.9rem;
        }

        /* Separators */
        .sidebar-separator-title {
            background-color: #333;
            height: 35px;
        }
        .sidebar-separator {
            background-color: #333;
            height: 25px;
        }
        .logo-separator {
            background-color: #333;    
            height: 60px;
        }

        /* Closed submenu icon */
        #sidebar-container .list-group .list-group-item[aria-expanded="false"] .submenu-icon::after {
            display: inline-block;
            text-align: right;
            padding-left: 10px;
            content: "\25BA";
            color: white;
        }
        /* Opened submenu icon */
        #sidebar-container .list-group .list-group-item[aria-expanded="true"] .submenu-icon::after {
            display: inline-block;
            text-align: right;
            padding-left: 10px;
            content: "\25BA";
            color: white;
            transform: rotate(90deg);
        }
    </style>
    <body>
        <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand" href="#">
            <span class="fa fa-toolbox mr-3"></span>
            <span class="menu-collapsed">Sistem Admin Absensi SMANDAK</span>
        </a>
        <div id="clock" style="float: right;">
        </div>
        </nav>

        <div class="row" id="body-row">
            <div id="sidebar-container" class="sidebar-expanded d-none d-md-block">
                <ul class="list-group">
                    <a href="#" data-toggle="sidebar-colapse" class="bg-dark list-group-item list-group-item-action d-flex align-items-center">
                        <div class="d-flex w-100 justify-content-start align-items-center">
                            <span id="collapse-icon" class="fa fa-2x mr-3"></span>
                            <span id="collapse-text" class="menu-collapsed">Tutup</span>
                        </div>
                    </a>

                    <li class="list-group-item sidebar-separator-title text-muted d-flex align-items-center menu-collapsed">
                        <small>MENU UTAMA</small>
                    </li>
                    <a href="#" onclick="dashboard()" class="bg-dark list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-start align-items-center">
                            <span class="fa fa-tachometer-alt fa-fw mr-3"></span>
                            <span class="menu-collapsed">Dashboard</span>    
                        </div>
                    </a>
                    <a href="#" onclick="check_filter()" class="bg-dark list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-start align-items-center">
                            <span class="fa fa-tasks fa-fw mr-3"></span>
                            <span class="menu-collapsed">Pengajuan <span class="badge badge-pill badge-success ml-2"><div id="countSurat"></div></span></span>   
                        </div>
                    </a>
                    
                    <li class="list-group-item sidebar-separator-title text-muted d-flex align-items-center menu-collapsed">
                        <small>REKAP</small>
                    </li>
                    <div id="content-class">
                    </div>

                    <li class="list-group-item sidebar-separator-title text-muted d-flex align-items-center menu-collapsed">
                        <small>OPTIONS</small>
                    </li>

                    <a href="#" onclick="upload_siswa()" class="bg-dark list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-start align-items-center">
                            <span class="fa fa-user fa-fw mr-3"></span>
                            <span class="menu-collapsed">Data Siswa</span>
                        </div>
                    </a>
                    <a href="#" onclick="settings()" class="bg-dark list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-start align-items-center">
                            <span class="fa fa-cogs fa-fw mr-3"></span>
                            <span class="menu-collapsed">Pengaturan</span>
                        </div>
                    </a>         
                    <a href="/logout" class="bg-dark list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-start align-items-center">
                            <span class="fa fa-sign-out-alt fa-fw mr-3"></span>
                            <span class="menu-collapsed">Keluar</span>
                        </div>
                    </a> 
                </ul>
            </div>
            <div class="col">
                <div style="margin:20px" id="content-title">
                </div>
                <div id="check-place" style="padding-top:3%;padding-left:3%;padding-bottom:0%">
                </div>
                <div id="accordion">
                <div class="card-body">
                <div id="content-view"></div>
                </div>
                </div>
            </div>
            
        </div>
    </body>

    <div class="modal fade bd-example-modal-md" id="modal-edit-recap" role="dialog">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header" style="padding:15px 50px;">
                    <h6><span class="fa fa-info"></span> Edit Rekap</h6>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body" style="padding:15px 50px;">
                    <div id="recap-name"></div>
                    <br>
                    Z:Kosong | A:Absen | S:Sakit | I:Izin | L:Libur
                    <br>
                    <div id="recap-list"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="edit_recap()" >Ubah</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bd-example-modal-md" id="modal-add-siswa" role="dialog">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header" style="padding:15px 50px;">
                    <div id="siswa-title"></div>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body" style="padding:15px 50px;">
                    Tipe:0 -> Siswa Non-Petugas | Tipe:1 Siswa Petugas | Kelas: Angkatan-Jurusan-Kelas
                    <p></p>
                    <input type="hidden" id="type">
                    <input type="text" class="form-control" placeholder="Nama" id="add-name"><br>
                    <input type="text" class="form-control" placeholder="Induk" id="add-induk"><br>
                    <input type="text" class="form-control" placeholder="Kelas (ex. X-IPA-1)" id="add-id_kelas"><br>
                    <input type="text" class="form-control" placeholder="Pasword" id="add-pwd"><br>
                    <input type="number" class="form-control" placeholder="Tipe (ex. 1)" id="add-tipe">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="add_siswa()" >Konfirmasi</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bd-example-modal-md" id="modal-question" role="dialog">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header" style="padding:15px 50px;">
                    Bantuan
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body" style="padding:15px 50px;">
                    <p>
                        File harus berbentuk CSV (bisa dibuat di excel).<br>
                        Kolom pertama berisi index dimulai dari 1.<br>
                        Kolom kedua berisi nomor induk.<br>
                        Kolom ketiga berisi nama.<br>
                        Kolom keempat berisi kelas, nama kelas harus berformat Angkatan-Jurusan-Kelas. (contoh X-IPA-3 dengan strip).<br>
                        Kolom kelima password, agar lebih mudah diisi acak/sama karena siswa dapat menggantinya.<br>
                        Kolom keenam berisi tipe, isi 0 untuk siswa biasa, isi 1 untuk ketua kelas/petugas.<br>
                        Petugas dapat melakuka fungsi khusus seperti pelaporan dan pengajuan surat sakit/izin.
                    </p>
                </div>
            </div>
        </div>
    </div>

</html>

<script>
    $('#body-row .collapse').collapse('hide'); 
    $('#collapse-icon').addClass('fa-angle-double-left');

    function clk(){
        $.ajax({
            method: 'get',
            url: '/get_clock',
            success: function(res){
                $("#clock").html('<i class="text-light" style="float: right;">'+res+'</i>');
            }
        })
    }

    setInterval(function(){
        clk();
    }, 10000);

    clk();

    $('[data-toggle=sidebar-colapse]').click(function() {
        SidebarCollapse();
    });

    function SidebarCollapse () {
        $('.menu-collapsed').toggleClass('d-none');
        $('.sidebar-submenu').toggleClass('d-none');
        $('.submenu-icon').toggleClass('d-none');
        $('#sidebar-container').toggleClass('sidebar-expanded sidebar-collapsed');
        
        // Treating d-flex/d-none on separators with title
        var SeparatorTitle = $('.sidebar-separator-title');
        if ( SeparatorTitle.hasClass('d-flex') ) {
            SeparatorTitle.removeClass('d-flex');
        } else {
            SeparatorTitle.addClass('d-flex');
        }
        
        // Collapse/Expand icon
        $('#collapse-icon').toggleClass('fa-angle-double-left fa-angle-double-right');
    }

    const month = [
        "None",
        "Januari", 
        "Februari", 
        "Maret", 
        "April", 
        "Mei", 
        "Juni", 
        "Juli", 
        "Agustus", 
        "September", 
        "Oktober", 
        "November", 
        "Desember"
    ];

    function date_format(s){
        let arr_s = s.split("/");
        fix = arr_s[0] + " " + month[parseInt(arr_s[1])] + " " + arr_s[2]; 
        return fix;
    }

    function open_img(names){
        arr = names.split("|");
        for(i=0; i<arr.length; i++){
            window.open(location.hostname+":"+location.port+"/uploads/"+arr[i]);
        }
    }

    function edit_surat(id, type){
        var data = {};
        data.id = id;
        data.type = type;
        $.ajax({
            url: '/update_surat',
            data: data,
            method: 'post',
            success: function(resp){
                return
            }
        });
        notif();
        count_surat();
    }

    $(document).ready(function() {
        dashboard();
        get_class();
        count_surat();
        $('.collapse').collapse();
    });

    function count_surat(){
        $.ajax({
            method: 'get',
            url: '/read_count_surat',
            success: function(res){
                $("#countSurat").html(res);
            }
        })
    }

    function check_filter(){
        html = "";
        html += "<form id='check'>";
        html += '<input type="checkbox" value=0 id="filter1" checked> Belum Dikonfirmasi &nbsp;&nbsp;&nbsp;&nbsp;';
        html += '<input type="checkbox" value=1 id="filter2" checked> Terkonfirmasi';
        html += "</form>";

        $('#check-place').html(html);
        $('#check-place').css("padding-top","3%");
        $('#check-place').css("padding-left","3%");
        $('#check-place').css("padding-bottom","0%");
        notif();

        $('#check :checkbox').change(function(){
            var confirm = [];
            i1 = $('#filter1').prop('checked');
            i2 = $('#filter2').prop('checked');
            i3 = $('#filter3').prop('checked');
            
            if(i1){
                confirm.push(0);
            }
            if(i2){
                confirm.push(1);
            }
            if(i3){
                confirm.push(-1);
            }

            notif(confirm);
        });
    }

    function notif(conf = [0,1,-1]){
        html = "";
        var data = {};
        data.confirm = conf.join("|")
        $.ajax({
            url: '/read_surat',
            data: data,
            dataType: 'json',
            method: 'post',
            success: function(resp){
                html = "";
                data = resp;
                for(i=0; i<data.length; i++){
                    if(data[i].confirm == 0 && data[i].to_name != "LAPORAN"){
                        html += '<div class="card border-success">';
                        html += '<div class="card-header bg-success" id="heading'+ i +'">';
                        html += '<button class="btn btn-link text-light" data-toggle="collapse" data-target="#collapse'+ i +'" aria-expanded="true" aria-controls="collapse'+ i +'"><span class="fa fa-info fa-fw mr-3"></span>Pengirim : '+ data[i].from_name +'</button>';
                        html += '<i class="text-light" style="float:right;padding-top:1%">'+ data[i].date_submit +'</i></div>';
                    }else if(data[i].confirm == 1 && data[i].to_name != "LAPORAN"){
                        html += '<div class="card border-info">';
                        html += '<div class="card-header bg-info" id="heading'+ i +'">';
                        html += '<button class="btn btn-link text-light" data-toggle="collapse" data-target="#collapse'+ i +'" aria-expanded="true" aria-controls="collapse'+ i +'"><span class="fa fa-check fa-fw mr-3"></span>Pengirim : '+ data[i].from_name +'</button>';
                        html += '<i class="text-light" style="float:right;padding-top:1%">'+ data[i].date_submit +'</i></div>';
                    }
                    
                    if(data[i].to_name == "LAPORAN"){
                        html += '<div class="card border-danger">';
                        html += '<div class="card-header bg-danger" id="heading'+ i +'">';
                        html += '<button class="btn btn-link text-light" data-toggle="collapse" data-target="#collapse'+ i +'" aria-expanded="true" aria-controls="collapse'+ i +'"><span class="fa fa-exclamation fa-fw mr-3"></span>Pengirim : '+ data[i].from_name +'</button>';
                        html += '<i class="text-light" style="float:right;padding-top:1%">'+ data[i].date_submit +'</i></div>';
                    }
                    html += '<div id="collapse'+ i +'" class="collapse" aria-labelledby="heading'+ i +'" data-parent="#accordion">';
                    html += '<div style="padding-bottom:6%" class="card-body">';
                    html += '<h6 class="card-title">'+ data[i].to_name +' : '+ data[i].subject +'</h6>';
                    if(data[i].to_name != "LAPORAN"){
                        html += '<span class="card-text">Mulai tanggal '+ date_format(data[i].from_date) + " sd. " + date_format(data[i].to_date) +'</span><br>';
                    }
                    html += '<span class="card-text">' + data[i].text + '</span><br>';
                    if(data[i].to_name != "LAPORAN"){
                        if(data[i].confirm == 0){
                            html += '<button type="button" class="btn btn-primary" style="float:right;margin:2px;" onclick=edit_surat("'+ data[i].id +'",1)><span class="fa fa-check fa-fw mr-3"></span>Konfirmasi</button>';
                        }
                        html += '<button type="button" class="btn btn-success" style="float:right;margin:2px;" onclick=open_img("'+ data[i].image +'")><span class="fa fa-camera fa-fw mr-3"></span>Lihat Surat</button>';
                    }
                    html += '</div></div></div><br>';
                }

                $('#content-view').html(html);
                $('#content-title').html("<h1>Pengajuan</h1>");
            }
        });
    }

    function get_class(){
        $.ajax({
            method: 'get',
            dataType: 'json',
            url: '/get_class',
            success: function(data){
                html = "";
            
                var angkatan = data.angkatan;
                var jurusan = data.jurusan;
                var kelas = data.kelas;
                var all = data.all;

                for(i=0; i<angkatan.length; i++){
                    html += '<a href="#submenu'+ angkatan[i] +'" data-toggle="collapse" aria-expanded="false" class="bg-dark list-group-item list-group-item-action flex-column align-items-start">';
                    html += '<div class="d-flex w-100 justify-content-start align-items-center">';
                    html += '<span class="fa fa-book fa-fw mr-3"></span>';
                    html += '<span class="menu-collapsed">Kelas '+ angkatan[i] +'</span>'
                    html += '<span class="submenu-icon ml-auto"></span>';
                    html += '</div></a>';
                    html += '<div id="submenu'+ angkatan[i] +'" class="collapse sidebar-submenu">';
                    for(m=0; m<jurusan.length; m++){
                        html += '<a href="#submenu'+ angkatan[i] + "-" +jurusan[m]+'" data-toggle="collapse" aria-expanded="false" class="bg-dark list-group-item list-group-item-action flex-column align-items-start">';
                        html += '<div class="d-flex w-100 justify-content-start align-items-start">';
                        html += '<span class="fa fa-book-open fa-fw mr-3"></span>';
                        html += '<span class="menu-collapsed">'+jurusan[m]+'</span>';
                        html += '<span class="submenu-icon ml-auto"></span>';
                        html += '</div></a>';
                        html += '<div id="submenu'+ angkatan[i] + "-" +jurusan[m]+'" class="collapse sidebar-submenu">';
                        for(n=0; n<kelas.length; n++){
                            st = angkatan[i] + '-' + jurusan[m] + '-' + kelas[n];
                            if(all.includes(st)){
                                html += '<a href="#" onclick="recap_filter(';
                                html += "'"+st+"'";
                                html += ')"';
                                html += 'class="list-group-item list-group-item-action bg-dark text-white">';
                                html += '<span class="menu-collapsed">'+st+'</span></a>';
                            }
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                }
                $('#content-class').html(html);
            }
        });
    }

    function delete_holiday(id){
        var data = {};
        data.id = id;
        $.ajax({
            url: '/delete_holiday',
            data: data,
            dataType: 'json',
            method: 'post',
            success: function(resp){
                settings();
            }
        });
    }

    function chng_pwd(){
        pwd = $('#pwd_new').val();
        conf = $('#pwd_new_conf').val();

        if(pwd != conf){
            alert("Password tidak cocok");
        }else{
            data = {};
            data.pwd = pwd;
            $.ajax({
                url: '/update_pwd',
                data: data,
                dataType: 'json',
                method: 'post',
                success: function(resp){
                    if(resp){
                        $('#pwd_new_conf').val("");
                        $('#pwd_new').val("");
                        settings();
                    }
                }
            });
        }
    }

    function recap_filter(id_class){
        $('#content-view').html("");
        
        $.ajax({
            url: '/get_periode',
            dataType: 'json',
            method: 'get',
            success: function(resp){
                var periode = [];
                for(i=0; i<resp.length; i++){
                    let ar = resp[i]["Tables_in_absensi_db (%record%)"].split('_');
                    let inx = parseInt(ar[1]);
                    periode.push(month[inx] + " " + ar[2]);
                }
                html = "";

                html += '<table><tr>';
                html += '<td>';
                html += '<div class="dropdown">';
                html += '<button class="btn btn-success dropdown-toggle" type="button" id="dropDownBulan" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Bulan</button> &nbsp';
                html += '<div class="dropdown-menu" aria-labelledby="dropDownBulan">';
                
                for(i=0; i<periode.length; i++){
                    html += '<a class="dropdown-item" href="#">'+periode[i]+'</a>';
                }
                html += '</div></div>';
                html += '</td>';
                html += '</tr></table>';

                $('#check-place').html(html);
                $('#check-place').css("padding-top","3%");
                $('#check-place').css("padding-left","3%");
                $('#check-place').css("padding-bottom","0%");
                $('#content-view').html("");
                $('#content-title').html("<h1>Rekap Absensi "+ id_class +"</h1>");

                $(".dropdown-menu a").click(function(){
                    var name_item = $(this).text().split(" ");
                    $('.dropdown-toggle').text($(this).text());
                    var index = month.indexOf(name_item[0]);
                    recap(index, parseInt(name_item[1]), id_class);
                });
            }
        });
    }

    function edit_recap(){
        var data = {};
        var induk = $('#my_induk').val();
        var rec = $('#my_record').val();
        data.induk = induk;
        data.rec = rec;
        
        days = {};
        var ele = document.querySelectorAll(".classDay");
        for(i=0; i<ele.length; i++){
            n = "day"+(i+1).toString();
            days[n] = ele[i].value;
        }
        data.day = days;
        $.ajax({
            url: "/edit_user_recap",
            method: "post",
            data: data,
            dataType: 'json',
            success: function(res){
                if(res == true){
                    $('#modal-edit-recap').modal('toggle');
                    alert("Sukses");
                }
            }
        })
    }

    function modal_edit_recap(name, m, year){
        $('#modal-edit-recap').modal('toggle');
        $('#recap-name').html(name+" | "+month[m]+" "+year);

        $.ajax({
            method: 'post',
            data: {name, m, year},
            url: "/get_user_recap",
            dataType: 'json',
            success: function(res){
                html = "";
                html += '<input type="hidden" id="my_induk" value="'+res[0]["induk"]+'">';
                html += '<input type="hidden" id="my_record" value="record_'+m+'_'+year+'">';
                html += "<table class='table table-bordered'>";
                html += "<tr><th>Tanggal</th><th>Kehadiran</th></tr>";
                for(i=0; i<(Object.keys(res[0]).length)-1; i++){
                    html += '<tr>';
                    html += '<td><center>'+(i+1).toString()+"</center></td>";
                    html += '<td><input class="classDay" id="day'+ (i+1).toString() +'" value="'+ res[0]['day'+(i+1).toString()] +'"';
                    html += '</tr>';
                }
                html += "</table>";
                $('#recap-list').html(html);
            }
        })
    }

    function recap(month, year, id_kelas){
        html = '';
        var data = {};
        data.id_kelas = id_kelas;
        data.month = month;
        data.year = year;
        $.ajax({
            url: '/read_recap',
            data: data,
            dataType: 'json',
            method: 'post',
            success: function(resp){
                dayscount = Object.keys(resp[0]).length-2;
                html = "";
                html += '<a href="/generate/record/record_'+month+'_'+year+'/class/'+id_kelas+'"><span class="fa fa-print fa-fw mr-3"></span>Cetak</a><p></p>'
                html += '<table class="table table-bordered" style="display:block; overflow-x: auto; max-width:1000px">';
                html += '<thead class="thead-dark"><tr>';
                html += '<th scope="col" style="width:5%">No</th>';
                html += '<th scope="col">Nama</th>';
                for(i=1; i<=dayscount; i++){
                    html += '<th scope="col" style="width:5%">'+i.toString()+'</th>';
                }
                html += '<th>Edit</th>'
                html += '</tr></thead>';

                html += '<tbody>';
                
                for(i=0; i<resp.length; i++){
                    html += '<tr>';
                    html += '<td>'+(i+1).toString()+'</td>';
                    html += '<td>'+resp[i].name+'</td>';
                    for(var key in resp[i]){
                        value = resp[i][key];
                        if(value.length == 1){
                            if(value == 'H'){
                                html += '<td>&#x2713</td>';
                            }else if(value == 'Z'){
                                html += '<td> </th>';
                            }else if(value == 'L'){
                                html += '<td class="bg-danger"></th>';
                            }else{
                                html += '<td>'+value+'</th>';
                            }
                        }
                    }
                    html += '<td><button type="button" class="btn btn-warning btn-sm" onclick="modal_edit_recap(';
                    html += "'"+resp[i].name+"','"+ month + "','" + year + "')";
                    html += '"href="#"><span class="fa fa-edit"></span></button></td></tr>';
                }
                html += '</tbody></table>';
            },
            async: false
        });

        $.ajax({
            method: 'post',
            url: '/read_all_recap',
            data: {'id_kelas':id_kelas},
            success: function(res){
                month_count = res.length;
                html += '<hr>';
                html += '<h5>Kalkulasi Semua Periode/Bulan</h5>';
                html += '<a href="/generate/recordall/class/'+id_kelas+'"><span class="fa fa-print fa-fw mr-3"></span>Cetak</a><p></p>'
                html += '<table class="table table-bordered" style="display:block; overflow-x: auto; max-width:1000px">';
                html += '<thead class="thead-dark"><tr>';
                html += '<th scope="col" style="width:5%" rowspan="2">No</th>';
                html += '<th scope="col" rowspan="2" style="text-align: center;">Nama</th>';
                for(i=1; i<=month_count; i++){
                    html += '<th scope="col" colspan="4" style="text-align: center;">'+i+'</th>';
                }
                html += '</tr>';
                html += '<tr>';
                for(i=1; i<=month_count; i++){
                    html += '<th scope="col" style="text-align: center;">H</th>';
                    html += '<th scope="col" style="text-align: center;">S</th>';
                    html += '<th scope="col" style="text-align: center;">I</th>';
                    html += '<th scope="col" style="text-align: center;">A</th>';
                }
                html += '</tr>';

                html += '<tbody>';

                name_ = [];

                for(i=0; i<res[0].length; i++){
                    name_.push(res[0][i].name);
                }
                
                for(c=0; c<name_.length;c++){
                    html += '<tr>';
                    html += '<td style="border-right:1px solid #d9534f; border-left:1px solid #d9534f;border-bottom:1px solid #d9534f">'+(c+1)+'</td>';
                    html += '<td style="border-right:1px solid #d9534f;border-bottom:1px solid #d9534f">'+name_[c]+'</td>';
                    for(i=0; i<month_count; i++){
                        html += '<td style="text-align: center;border-bottom:1px solid #d9534f">'+res[i][c].h+'</td>';
                        html += '<td style="text-align: center;border-bottom:1px solid #d9534f">'+res[i][c].s+'</td>';
                        html += '<td style="text-align: center;border-bottom:1px solid #d9534f">'+res[i][c].i+'</td>';
                        html += '<td style="text-align: center;border-right:1px solid #d9534f;border-bottom:1px solid #d9534f">'+res[i][c].a+'</td>';
                    }
                    html += '</tr>';
                }
                html += '</tbody>';
                html += '</table>';
            },
            async: false
        })

        $('#content-view').html(html);
    }

    function closeAttend(){
        var val = confirm('Tutup akses presensi dan update presensi ?');
        if(val){
            $.ajax({
                method: 'get',
                url: '/close_attend',
                success: function(res){
                    if(res){
                        alert("Sukses");
                    }else{
                        alert("Gagal");
                    }
                }
            })
        }
    }

    function settings(){
        $('#check-place').html("");
        $('#check-place').css("padding","0%");
        html = "";
        
        var holiday_date = {};
        var access_time = {};

        $.ajax({
            url: '/read_access_time',
            data: {},
            dataType: 'json',
            method: 'post',
            success: function(resp){
                access_time = resp[0];
                html += "<div style='border: 1px solid #ccc;'>";
                html += "<div style='padding-top: 2%; padding-bottom: 2%; padding-left:2%;padding-right:2%'>";
                html += '<h6><span class="fa fa-clock fa-fw mr-3"></span>Akses Interval Waktu (00-24)<h6><hr>';
                html += '<button onclick="closeAttend()" class="btn btn-danger">Tutup Akses Presensi</button>';
                html += '<hr>';
                html += '<form id="edit_time">'
                html += "<table>";
                html += '<thead><td>Waktu aktif</td>';
                html += '<td>Waktu non-aktif</td></thead>';
                html += '<tbody><td><input class="form-control" autocomplete="off" type="text" id="active_time" value="'+ access_time.from_time +'" required></td>';
                html += '<td><input class="form-control" autocomplete="off" type="text" id="non_time" value="'+ access_time.until_time +'" disabled></tbody></td>';
                html += "</table><p></p>";
                html += '<button type="submit" class="btn btn-primary">Konfirmasi</button>';
                html += "</form></div></div><br>";
            },
            async: false
        });

        $.ajax({
            url: '/read_holiday',
            data: {},
            dataType: 'json',
            method: 'post',
            success: function(resp){
                holiday_date = resp;
                html += "<div style='border: 1px solid #ccc;'>";
                html += "<div style='padding-top: 2%; padding-bottom: 2%; padding-left:2%;padding-right:2%'>";
                html += '<h6><span class="fa fa-calendar-times fa-fw mr-3"></span>Hari Libur<h6><hr>';
                html += "<form id='add_holi'>"
                html += "<table>";
                html += '<td><input class="form-control" type="text" id="tgl_libur" autocomplete="off" placeholder="Pilih Tanggal" required></td>';
                html += '<td><button type="submit" class="btn btn-primary"><span class="fa fa-plus"></span></button></td></table></form>';
                html += '<table class="table" style="max-height: 200px;overflow:auto;display: inline-block;">';
                html += '<tbody>';
                for(i=0; i<holiday_date.length; i++){
                    html += '<tr><td>'+ date_format(holiday_date[i].tgl) +'</td>';
                    html += '<td><button type="button" class="btn btn-danger btn-sm" onclick="delete_holiday('+ holiday_date[i].id +')" ><span class="fa fa-trash-alt"></span></button></td>';
                    html += '</tr>';
                }
                html += "</tbody></table></div></div><br>";
            },
            async: false
        });

        html += "<div style='border: 1px solid #ccc;'>";
        html += "<div style='padding-top: 2%; padding-bottom: 2%; padding-left:2%;padding-right:2%'>";
        html += '<h6><span class="fa fa-key fa-fw mr-3"></span>Ganti Password<h6><hr>';
        html += '<input class="form-control" type="password" name="pwd_new" id="pwd_new" placeholder="Password Baru" required><p></p>';
        html += '<input class="form-control" type="password" name="pwd_new_conf" id="pwd_new_conf" placeholder="Password Baru (ulangi)" required><p></p>';
        html += '<button type="button" class="btn btn-primary" onclick="chng_pwd()" >Konfirmasi</button>';
        html += "</div></div>";

        $('#content-view').html(html);
        $('#content-title').html("<h1>Pengaturan</h1>");

        var dateToday = new Date();
        $('#tgl_libur').datepicker({
            dateFormat: 'dd/mm/yy',
            stepMonths: 0,
            beforeShowDay: function(day) {
                var day = day.getDay();
                if (day == 0) {
                    return [false, "somecssclass"]
                } else {
                    return [true, "someothercssclass"]
                }
            },
            minDate: dateToday
        });
        $('#active_time').timepicker();
        $('#non_time').timepicker();

        $('#add_holi').on('submit', function (event){
            tgl = $('#tgl_libur').val();
            data = {};
            data.tgl = tgl;
            $.ajax({
                url: '/create_holiday',
                data: data,
                dataType: 'json',
                method: 'post',
                success: function(resp){
                    if(resp){
                        settings();
                    }
                }
            });
        });

        $('#edit_time').on('submit', function (event){
            from_time = $('#active_time').val();
            until_time = $('#non_time').val();
            data = {};
            data.from_time = from_time;
            data.until_time = until_time;
            $.ajax({
                url: '/update_access_time',
                data: data,
                dataType: 'json',
                method: 'post',
                success: function(resp){
                    settings();
                }
            });
        });
    }

    function add_siswa(){
        if($("#type").val() == 1){
            name = $("#add-name").val();
            induk = $("#add-induk").val();
            id_kelas = $("#add-id_kelas").val();
            pwd = $("#add-pwd").val();
            tipe = $("#add-tipe").val();

            data = {};
            data.name = name;
            data.induk = induk;
            data.id_kelas = id_kelas;
            data.pwd = pwd;
            data.tipe = tipe;
            $.ajax({
                method: 'post',
                url: '/add_siswa',
                data: data,
                dataType: 'json',
                success: function(res){
                    if(res){
                        $("#add-name").val("");
                        $("#add-induk").val("");
                        $("#add-id_kelas").val("");
                        $("#add-pwd").val("");
                        $("#add-tipe").val("");
                        $('#modal-add-siswa').modal('toggle');
                        alert("Sukses");
                        siswa();
                    }else{
                        alert("Gagal");
                    }
                }
            });
        }else if($("#type").val() == 2){
            name = $("#add-name").val();
            induk = $("#add-induk").val();
            id_kelas = $("#add-id_kelas").val();
            pwd = $("#add-pwd").val();
            tipe = $("#add-tipe").val();

            data = {};
            data.name = name;
            data.induk = induk;
            data.id_kelas = id_kelas;
            data.pwd = pwd;
            data.tipe = tipe;
            $.ajax({
                method: 'post',
                url: '/edit_siswa',
                data: data,
                dataType: 'json',
                success: function(res){
                    if(res){
                        $("#add-name").val("");
                        $("#add-induk").val("");
                        $("#add-id_kelas").val("");
                        $("#add-pwd").val("");
                        $("#add-tipe").val("");
                        $('#modal-add-siswa').modal('toggle');
                        alert("Sukses");
                        siswa();
                    }else{
                        alert("Gagal");
                    }
                }
            });
        }
        
    }

    function delete_siswa(induk){
        var ret = confirm("Apakah anda yakin akan menghapus ?");
        if(ret){
            $.ajax({
                method: 'post',
                url: '/delete_siswa',
                data: {induk},
                dataType: 'json',
                success: function(res){
                    if(res){
                        alert("Sukses");
                        siswa();
                    }else{
                        alert("Gagal");
                    }
                }
            });
        }
    }

    function modal_add_siswa(){
        $('#modal-add-siswa').modal('toggle');
        $('#siswa-title').html("<h6>Tambah Siswa</h6>");
        $('#type').val(1);
    }

    function modal_edit_siswa(induk){
        $.ajax({
            method: 'post',
            url: '/get_siswa_by_induk',
            data: {induk},
            dataType: 'json',
            success: function(res){
                $('#modal-add-siswa').modal('toggle');
                $('#siswa-title').html("<h6>Edit Siswa</h6>");
                $('#type').val(2);
                $("#add-name").val(res.name);
                $("#add-induk").val(res.induk);
                $("#add-id_kelas").val(res.id_kelas);
                $("#add-pwd").val(res.pwd);
                $("#add-tipe").val(res.tipe);
                $("#add-induk").attr("disabled", true);
            }
        })
    }

    function upload_siswa(){
        html = "";

        html += '<form id="upload-siswa" method="post" action="/upload_siswa" enctype="multipart/form-data">';
        html += '<input id="datas-input" type="file" name="datas[]" multiple="multiple"><p></p>';
        html += '<input class="btn btn-success" type="submit" name="Ajukan Uploads" value="Unggah"/>&nbsp;&nbsp;';
        html += '<button class="btn btn-secondary" type="button" data-toggle="modal" data-target="#modal-question" href="#"><span class="fa fa-question fa-fw mr-3"></span>Bantuan</button></form><hr>';
        html += '<button class="btn btn-primary" onclick="modal_add_siswa()"><span class="fa fa-user-plus fa-fw mr-3"></span>Tambah</button>';

        $('#check-place').html(html);
        $('#check-place').css("padding-top","3%");
        $('#check-place').css("padding-left","3%");
        $('#check-place').css("padding-bottom","0%");

        siswa();

        $('#upload-siswa').on('submit', function (event) {
            event.preventDefault();

            var files = $('#datas-input').get(0).files,
                formData = new FormData();

            if (files.length > 1) {
                alert('Upload maksimal 1 file');
                return false;
            }

            for (var i=0; i < files.length; i++) {
                var file = files[i];
                formData.append('datas[]', file, file.name);
            }

            uploadFiles(formData);
        });
        
    }

    function uploadFiles(formData) {
        $.ajax({
            url: '/upload_siswa',
            method: 'post',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function () {
                var xhr = new XMLHttpRequest();
                return xhr;
            }
        }).done(handleSuccess).fail(function (xhr, status) {
            alert(status);
        });
    }

    function handleSuccess(data) {
        siswa();
        get_class();
    }

    function siswa(){
        $.ajax({
            method: 'get',
            dataType: 'json',
            url: '/read_siswa',
            success: function(data){
                html = "";
                html += '<table class="table">';
                html += '<thead class="thead-dark">';
                html += '<tr><th scope="col">No</th><th scope="col">Induk</th><th scope="col">Nama</th><th scope="col">Kelas</th><th scope="col">Password</th><th scope="col">Status</th><th scope="col">Aksi</th></tr></thead>';
                html += '<tbody>';
                for(i=0; i<data.length; i++){
                    html += '<tr><th scope="row">'+data[i].id+'</th>';
                    html += '<th>'+data[i].induk+'</th>';
                    html += '<th>'+data[i].name+'</th>';
                    html += '<th>'+data[i].id_kelas+'</th>';
                    html += '<th>'+data[i].pwd+'</th>';
                    if(data[i].tipe == 0){
                        html += '<th>Siswa</th>';    
                    }else{
                        html += '<th>Petugas</th>';
                    }
                    html += '<th><button type="button" class="btn btn-warning btn-sm" onclick="modal_edit_siswa(';
                    html += "'"+ data[i].induk +"')";
                    html += '"><span class="fa fa-edit"></span></button>&nbsp<button type="button" class="btn btn-danger btn-sm" onclick="delete_siswa(';
                    html += "'"+ data[i].induk +"')";
                    html += '"><span class="fa fa-trash-alt"></span></button></th></tr>';
                    
                }
                html += '</tbody></table>';
                
                $('#content-view').html(html);
                $('#content-title').html("<h1>Data Siswa</h1>");
            }
        });
    }


    function dashboard(){
        html = "";
        tmpH = 0;
        tmpI = 0;
        tmpS = 0;
        tmpA = 0;
        var time;
        var temp_1;
        var temp_2;
        var temp_3;
        var temp_4;
        $.ajax({
            method: 'get',
            url: '/get_dashboard',
            success: function(res){
                tmpH = res['x'][res['x'].length-1][0];
                tmpI = res['x'][res['x'].length-1][1];
                tmpS = res['x'][res['x'].length-1][2];
                tmpA = res['x'][res['x'].length-1][3];

                time = res['y'];
                temp_1 = [];
                temp_2 = [];
                temp_3 = [];
                temp_4 = [];

                for(i=0; i<res['x'].length; i++){
                    temp_1.push(res['x'][i][0]);
                    temp_2.push(res['x'][i][1]);
                    temp_3.push(res['x'][i][2]);
                    temp_4.push(res['x'][i][3]);
                }
            },
            async: false
        })
        html += '<div class="col">';
            html += '<h5>Hari ini</h5>';
            html += '<div class="card-deck">';
                html += '<div class="card bg-primary text-light" style="text-align: center">'
                    html += '<div class="card-body bg-primary">';
                        html += '<h1>'+tmpH+'</h1>';
                    html += '</div>'
                    html += '<div class="card-body bg-primary">';
                        html += '<h5>Hadir</h5>'
                    html += '</div>';
                html += '</div>';
                html += '<div class="card bg-success text-light"  style="text-align: center">'
                    html += '<div class="card-body bg-success">';
                        html += '<h1>'+tmpS+'</h1>';
                    html += '</div>'
                    html += '<div class="card-body bg-success">';
                        html += '<h5>Sakit</h5>'
                    html += '</div>';
                html += '</div>';
                html += '<div class="card bg-secondary text-light" style="text-align: center">'
                    html += '<div class="card-body bg-secondary">';
                        html += '<h1>'+tmpI+'</h1>';
                    html += '</div>'
                    html += '<div class="card-body bg-secondary">';
                        html += '<h5>Izin</h5>'
                    html += '</div>';
                html += '</div>';
                html += '<div class="card bg-danger text-light" style="text-align: center">'
                    html += '<div class="card-body bg-danger">';
                        html += '<h1>'+tmpA+'</h1>';
                    html += '</div>'
                    html += '<div class="card-body bg-danger">';
                        html += '<h5>Absen</h5>'
                    html += '</div>';
                html += '</div>';
            html += '</div>';
        html += '</div>';
        html += '<br>';
        html += '<hr>';
        html += '<div class="col">';
            html += '<h5>Bulan ini</h5>';
            html += '<div style="width:100%;"><canvas id="canvas"></canvas></div>';
        html += '</div>';

        $('#content-view').html(html);
        $('#check-place').html("");
        $('#check-place').css("padding","0%");
        $('#content-title').html("<h1>Dashboard</h1>");

        var ctx_1 = document.getElementById("canvas");

        var myChart_1 = new Chart(ctx_1, {
        type: 'line',
        data: {
            labels: time,
            datasets: [
            { 
                data: temp_1,
                label: "Hadir",
                borderColor: "#0275d8",
                fill: false
            },
            { 
                data: temp_2,
                label: "Sakit",
                borderColor: "#5cb85c",
                fill: false
            },
            { 
                data: temp_3,
                label: "Izin",
                borderColor: "#5bc0de",
                fill: false
            },
            { 
                data: temp_4,
                label: "Absen",
                borderColor: "#d9534f",
                fill: false
            },
            ]
        },
        options: {
				responsive: true,
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Tanggal'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Siswa'
						}
					}]
				}
			}
        });
    }

</script>